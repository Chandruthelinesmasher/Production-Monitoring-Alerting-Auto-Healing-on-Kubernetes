name: SRE AKS CI/CD Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

env:
  TF_VERSION: "1.6.6"

  # App
  IMAGE_NAME: k8s-sre-monitoring-app

  # Infra
  LOCATION: eastus2
  RESOURCE_GROUP: rg-sre-monitoring-dev

  # Terraform Backend
  BACKEND_RESOURCE_GROUP: rg-terraform-state
  BACKEND_STORAGE_ACCOUNT: tfstatesremonitoring
  BACKEND_CONTAINER: tfstate
  BACKEND_KEY: sre-monitoring-dev.tfstate

jobs:
# ==========================================================
# TERRAFORM â€“ INFRASTRUCTURE
# ==========================================================
  terraform:
    name: Terraform Infra
    runs-on: ubuntu-latest

    outputs:
      acr_login_server: ${{ steps.tfout.outputs.acr_login_server }}
      acr_name: ${{ steps.tfout.outputs.acr_name }}
      aks_name: ${{ steps.tfout.outputs.aks_name }}
      resource_group: ${{ steps.tfout.outputs.resource_group }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------
      # Azure Login (Secret Method)
      # -----------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------
      # Export ARM vars for Terraform
      # -----------------------------
      - name: Export ARM variables
        run: |
          CREDS='${{ secrets.AZURE_CREDENTIALS }}'
          echo "ARM_CLIENT_ID=$(echo $CREDS | jq -r .clientId)" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo $CREDS | jq -r .clientSecret)" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo $CREDS | jq -r .tenantId)" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(echo $CREDS | jq -r .subscriptionId)" >> $GITHUB_ENV

      # -----------------------------
      # Setup Terraform
      # -----------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      # -----------------------------
      # Backend Storage (Idempotent)
      # -----------------------------
      - name: Setup Terraform Backend
        run: |
          az group create \
            --name $BACKEND_RESOURCE_GROUP \
            --location $LOCATION \
            --tags purpose=terraform-state || true

          if ! az storage account show \
            --name $BACKEND_STORAGE_ACCOUNT \
            --resource-group $BACKEND_RESOURCE_GROUP &>/dev/null; then
            az storage account create \
              --name $BACKEND_STORAGE_ACCOUNT \
              --resource-group $BACKEND_RESOURCE_GROUP \
              --location $LOCATION \
              --sku Standard_LRS \
              --https-only true
          fi

          ACCOUNT_KEY=$(az storage account keys list \
            --resource-group $BACKEND_RESOURCE_GROUP \
            --account-name $BACKEND_STORAGE_ACCOUNT \
            --query '[0].value' -o tsv)

          az storage container create \
            --name $BACKEND_CONTAINER \
            --account-name $BACKEND_STORAGE_ACCOUNT \
            --account-key $ACCOUNT_KEY || true

      # -----------------------------
      # Terraform Init
      # -----------------------------
      - name: Terraform Init
        run: |
          cd terraform
          terraform init -upgrade \
            -backend-config="resource_group_name=$BACKEND_RESOURCE_GROUP" \
            -backend-config="storage_account_name=$BACKEND_STORAGE_ACCOUNT" \
            -backend-config="container_name=$BACKEND_CONTAINER" \
            -backend-config="key=$BACKEND_KEY"

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      - name: Terraform Plan
        run: |
          cd terraform
          terraform plan \
            -var="location=$LOCATION" \
            -var="resource_group_name=$RESOURCE_GROUP" \
            -var="environment=dev" \
            -out=tfplan

      - name: Terraform Apply
        run: |
          cd terraform
          terraform apply -auto-approve tfplan

      # -----------------------------
      # Manual ACR Role Assignment (Workaround)
      # -----------------------------
      - name: Configure ACR Pull Permission for AKS
        run: |
          # Get the AKS kubelet identity
          AKS_KUBELET_ID=$(az aks show \
            --resource-group $RESOURCE_GROUP \
            --name $(cd terraform && terraform output -raw aks_cluster_name) \
            --query identityProfile.kubeletidentity.objectId -o tsv)
          
          # Get ACR resource ID
          ACR_ID=$(az acr show \
            --name $(cd terraform && terraform output -raw acr_name) \
            --resource-group $RESOURCE_GROUP \
            --query id -o tsv)
          
          # Assign AcrPull role (idempotent)
          az role assignment create \
            --assignee $AKS_KUBELET_ID \
            --role AcrPull \
            --scope $ACR_ID || echo "Role assignment already exists"

      - name: Export Terraform Outputs
        id: tfout
        run: |
          cd terraform
          echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
          echo "acr_name=$(terraform output -raw acr_name)" >> $GITHUB_OUTPUT
          echo "aks_name=$(terraform output -raw aks_cluster_name)" >> $GITHUB_OUTPUT
          echo "resource_group=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT

# ==========================================================
# BUILD & PUSH IMAGE
# ==========================================================
  build-and-push:
    name: Build & Push Docker Image
    needs: terraform
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ needs.terraform.outputs.acr_name }}

      - name: Build Image
        working-directory: app
        run: |
          docker build \
            -t ${{ needs.terraform.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:latest .

      - name: Push Image
        run: |
          docker push ${{ needs.terraform.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:latest

# ==========================================================
# DEPLOY APP + MONITORING
# ==========================================================
  deploy:
    name: Deploy App & Monitoring
    needs: [terraform, build-and-push]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ needs.terraform.outputs.resource_group }} \
            --name ${{ needs.terraform.outputs.aks_name }} \
            --overwrite-existing

      - name: Create Namespaces
        run: |
          kubectl create namespace app --dry-run=client -o yaml | kubectl apply -f -
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Application
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|${{ needs.terraform.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:latest|g" k8s/app/deployment.yaml
          kubectl apply -f k8s/app -n app

      - name: Deploy Monitoring Stack
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
            -n monitoring \
            --set grafana.adminPassword=admin123 \
            --wait